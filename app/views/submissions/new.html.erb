<div class="max-w-2xl mx-auto">
  <div class="mb-6">
    <%= link_to group_season_week_path(@group, @season, @week), class: "text-purple-400 hover:text-purple-300 inline-flex items-center" do %>
      <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to Week <%= @week.number %>
    <% end %>
  </div>

  <div class="bg-gray-800 rounded-lg p-8 border border-gray-700">
    <h1 class="text-3xl font-bold mb-2">Submit Your Song</h1>
    <p class="text-purple-400 font-semibold text-lg mb-8"><%= @week.category %></p>

    <div class="bg-blue-500/10 border border-blue-500 rounded-lg p-4 mb-6">
      <p class="text-blue-300 text-sm">
        <strong>Deadline:</strong> <%= @week.submission_deadline.strftime("%B %d at %I:%M %p") %>
        <br>
        <strong>Time remaining:</strong> <%= distance_of_time_in_words(Time.current, @week.submission_deadline) %>
      </p>
    </div>

    <%= form_with model: @submission, url: group_season_week_submissions_path(@group, @season, @week), class: "space-y-6" do |f| %>
      <% if @submission.errors.any? %>
        <div class="bg-red-500/10 border border-red-500 rounded-lg p-4">
          <h3 class="font-semibold text-red-400 mb-2">
            <%= pluralize(@submission.errors.count, "error") %> prevented this submission from being saved:
          </h3>
          <ul class="list-disc list-inside text-red-300">
            <% @submission.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="space-y-3">
        <label for="tidal-query" class="block text-sm font-semibold">Search Tidal</label>
        <div class="relative">
          <input
            id="tidal-query"
            name="tidal_query"
            type="text"
            autocomplete="off"
            class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:ring-1 focus:ring-purple-500"
            placeholder="Start typing a song or artist name"
          />
          <div id="tidal-suggestions" class="absolute z-10 mt-2 w-full bg-gray-900 border border-gray-700 rounded-lg shadow-lg hidden"></div>
        </div>
        <p class="text-sm text-gray-400">
          Tidal-only submissions. Choose a track from the suggestions to fill in your submission.
        </p>
        <p id="tidal-error" class="text-sm text-red-400 hidden">Select a track from the list before submitting.</p>
      </div>

      <div id="tidal-selected" class="hidden border border-gray-700 rounded-lg p-4 bg-gray-900/60">
        <div class="flex items-center gap-4">
          <img id="tidal-cover" alt="" class="w-16 h-16 rounded-md object-cover bg-gray-800" />
          <div>
            <p id="tidal-title" class="text-lg font-semibold"></p>
            <p id="tidal-artist" class="text-purple-400"></p>
            <p id="tidal-album" class="text-sm text-gray-400"></p>
          </div>
        </div>
      </div>

      <%= f.hidden_field :song_title, id: "submission-song-title" %>
      <%= f.hidden_field :artist, id: "submission-artist" %>
      <%= f.hidden_field :song_url, id: "submission-song-url" %>
      <%= f.hidden_field :tidal_id, id: "submission-tidal-id" %>

      <div class="flex items-center justify-between pt-4">
        <%= f.submit "Submit Song", class: "bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-semibold cursor-pointer" %>
        <%= link_to "Cancel", group_season_week_path(@group, @season, @week), class: "text-gray-400 hover:text-white" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", () => {
    const input = document.getElementById("tidal-query");
    const suggestions = document.getElementById("tidal-suggestions");
    const selectedCard = document.getElementById("tidal-selected");
    const errorText = document.getElementById("tidal-error");
    const titleField = document.getElementById("submission-song-title");
    const artistField = document.getElementById("submission-artist");
    const urlField = document.getElementById("submission-song-url");
    const tidalIdField = document.getElementById("submission-tidal-id");
    const coverImg = document.getElementById("tidal-cover");
    const titleText = document.getElementById("tidal-title");
    const artistText = document.getElementById("tidal-artist");
    const albumText = document.getElementById("tidal-album");
    const form = input.closest("form");
    let debounceTimer = null;

    const clearSelection = () => {
      titleField.value = "";
      artistField.value = "";
      urlField.value = "";
      tidalIdField.value = "";
      selectedCard.classList.add("hidden");
    };

    const setSelection = (track) => {
      titleField.value = track.title;
      artistField.value = track.artist;
      urlField.value = track.url;
      tidalIdField.value = track.id;
      coverImg.src = track.image_url || "";
      coverImg.alt = track.album ? `Album cover for ${track.album}` : "Album cover";
      titleText.textContent = track.title;
      artistText.textContent = track.artist;
      albumText.textContent = track.album || "Unknown album";
      selectedCard.classList.remove("hidden");
      errorText.classList.add("hidden");
    };

    const renderSuggestions = (tracks) => {
      suggestions.innerHTML = "";
      if (!tracks.length) {
        suggestions.classList.add("hidden");
        return;
      }

      tracks.forEach((track) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "w-full text-left px-4 py-3 hover:bg-gray-800 border-b border-gray-800 last:border-b-0";
        item.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gray-800 rounded-md overflow-hidden flex-shrink-0">
              ${track.image_url ? `<img src="${track.image_url}" alt="" class="w-full h-full object-cover" />` : ""}
            </div>
            <div>
              <p class="font-semibold">${track.title}</p>
              <p class="text-sm text-gray-400">${track.artist}${track.album ? ` â€¢ ${track.album}` : ""}</p>
            </div>
          </div>
        `;
        item.addEventListener("click", () => {
          input.value = `${track.title} - ${track.artist}`;
          setSelection(track);
          suggestions.classList.add("hidden");
        });
        suggestions.appendChild(item);
      });

      suggestions.classList.remove("hidden");
    };

    const fetchSuggestions = () => {
      const query = input.value.trim();
      if (query.length < 2) {
        suggestions.classList.add("hidden");
        clearSelection();
        return;
      }

      fetch("<%= search_group_season_week_submissions_path(@group, @season, @week) %>?query=" + encodeURIComponent(query), {
        headers: { Accept: "application/json" }
      })
        .then((response) => response.json())
        .then((data) => renderSuggestions(data.tracks || []))
        .catch(() => {
          suggestions.classList.add("hidden");
        });
    };

    input.addEventListener("input", () => {
      clearSelection();
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fetchSuggestions, 250);
    });

    document.addEventListener("click", (event) => {
      if (!suggestions.contains(event.target) && event.target !== input) {
        suggestions.classList.add("hidden");
      }
    });

    form.addEventListener("submit", (event) => {
      if (!tidalIdField.value) {
        event.preventDefault();
        errorText.classList.remove("hidden");
        input.focus();
      }
    });
  });
</script>
